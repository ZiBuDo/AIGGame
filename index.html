<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
	<link href="css/style.css" rel="stylesheet">
	<link rel="stylesheet" href="css/fonts-awesome.min.css">
    <link rel="icon" href="http://projects.miscthings.xyz/assets/img/favicon.ico">
	<link rel="shortcut icon" href="http://projects.miscthings.xyz/assets/img/favicon.ico" />
    <title>AIG Game</title>

    <!-- Bootstrap core CSS -->
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/jquery-ui.min.css" rel="stylesheet">
	<link href="css/justified-nav.css" rel="stylesheet">
	<link href="css/mdb.min.css" rel="stylesheet">
    <!-- Custom styles for this template 
    <link href="jumbotron.css" rel="stylesheet">
	-->
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	<?php
	/*
	ini_set('display_errors', 1);
	ini_set('display_startup_errors', 1);
	error_reporting(E_ALL);
	*/
		session_start();
		//activation code
		$info = "display:none";
		require "assets/php/database.php";
		require "assets/php/file.php";
		$decisions = readFileInput('/home/mindsumo/AIG/decisions.json'); 
		$dec = 0;
		if(isset($_GET["activate"])){
			$activate = $_GET["activate"];
			$emailAct = $_GET["email"];
			//check if activate and email match and need to be activated
			$conn = connect();
			$stmt = $conn->prepare("SELECT * FROM `AIG_Players` WHERE `Email` = :emailAct AND `Activation` = :activate");
			$stmt->bindParam(':emailAct', $emailAct, PDO::PARAM_STR);
			$stmt->bindParam(':activate', $activate, PDO::PARAM_STR);
			$stmt->execute();
			$result = $stmt->fetchAll();
			$rows = $stmt->rowCount();
			$player = $result[0];
			if($rows > 0){
				//check if activated
				if($player["Activated"] == "No"){
					$stmt = $conn->prepare("UPDATE `AIG_Players` SET `Activated` = 'Yes' WHERE `Email` = :emailAct AND `Activation` = :activate");
					$stmt->bindParam(':emailAct', $emailAct, PDO::PARAM_STR);
					$stmt->bindParam(':activate', $activate, PDO::PARAM_STR);
					$stmt->execute();
					$info = "";
					$infoContent = "Email address has been activated! Please Login!";
				}else{
					$info = "";
					$infoContent = "Email address has already been activated.";
				}
			}
		}
		
	
		$sess = false;
		$screen = "Login";
		$sprite = "general/alberto.png";
		$emailSess = "";
		$social = "";
		$risk = "[50,50,50,50,50,50,50]";
		if(session_id() != '' && isset($_SESSION)) {
			// session is started
			$sess = true;
			if(!isset($_SESSION["screen"])){
				$sess = false;
			}else{
				$screen = $_SESSION["screen"];
			}
			if(!isset($_SESSION["sprite"])){
				$sess = false;
			}else{
				$sprite = $_SESSION["sprite"];
			}
			if(!isset($_SESSION["email"])){
				$sess = false;
			}else{
				$emailSess = $_SESSION["email"];
			}
			if(!isset($_SESSION["social"])){
				$sess = false;
			}else{
				$social = $_SESSION["social"];
			}
			if(!isset($_SESSION["risk"])){
				$sess = false;
			}else{
				$risk = $_SESSION["risk"];
			}
			if(!isset($_SESSION["decisions"])){
				$sess = false;
			}else{
				$dec = $_SESSION["decisions"];
			}
		}
		if($sess == false){
			$dec = 0;
			$risk = "[50,50,50,50,50,50,50]";
		}
		$extraRisks = "[]";
		$extraNames = "[]";
		$moreSprites = "";
		$addSprites = "[]";
		if($sess == true){
			$conn = connect();
			$extraNames = "[";
			$extraRisks = "[";
			$addSprites = "[";
			$socialArr = json_decode(json_decode($social, true),true);
			shuffle($socialArr);
				foreach($socialArr as $friend){
					$stmt = $conn->prepare("SELECT * FROM `AIG_Players` WHERE `Name` = :name AND `Activated` = 'Yes'");
					$stmt->bindParam(':name', $friend, PDO::PARAM_STR);
					$stmt->execute();
					$result = $stmt->fetchAll();
					$dude = $result[0];
					$dudeSprite = $dude["Sprite"];
					$dudeRisk = $dude["Risk"];
					$dudeName = $dude["Name"];
					$src = "assets/sprites/" . $dudeSprite;
					$addSprites .= "\"$src\",";
					$extraRisks .= "\"$dudeRisk\",";
					$extraNames .= "\"$dudeName\",";
				}
				if($addSprites == "["){
					$addSprites .= "]";
				}else{
					$addSprites = substr($addSprites,0,strlen($addSprites) - 1);
					$addSprites .= "]";
				}
				if($extraRisks == "["){
					$extraRisks .= "]";
				}else{
					$extraRisks = substr($extraRisks,0,strlen($extraRisks) - 1);
					$extraRisks .= "]";
				}
				if($extraNames == "["){
					$extraNames .= "]";
				}else{
					$extraNames = substr($extraNames,0,strlen($extraNames) - 1);
					$extraNames .= "]";
				}
			$arrSprites = json_decode($addSprites);
			for($i = 0; $i < count($arrSprites); $i ++){
				$sp = $arrSprites[$i];
				$tmp = $i + 1;
				$moreSprites .= "<img id='spriteSheet$tmp' style='display:none' src='$sp'>";
				if($i == 4){
					break;
				}
			}
		}
		
	?>
	<script type="text/javascript">
		var emailSess = '<?php echo $emailSess; ?>';
		var spriteSess = "assets/sprites/" + '<?php echo $sprite; ?>';
		var riskSess = '<?php echo $risk; ?>';
		var social = '<?php echo $social; ?>';
		var otherSprites = '<?php echo $addSprites; ?>';
		var isSession = '<?php echo $sess ?>';
		var decisions = '<?php echo $decisions ?>';
		var dec = '<?php echo $dec ?>';
		var extraRisks = '<?php echo $extraRisks ?>';
		var extraNames = '<?php echo $extraNames ?>';
		var screenSess = '<?php echo $screen ?>';
		dec = Number(dec);
	</script>
  </head>
	
  <body>
	
	<div class="container">
	<center>
		<div class="loader">
			<div class="loader-inner">
				<div class="loader-line-wrap">
					<div class="loader-line"></div>
				</div>
				<div class="loader-line-wrap">
					<div class="loader-line"></div>
				</div>
				<div class="loader-line-wrap">
					<div class="loader-line"></div>
				</div>
				<div class="loader-line-wrap">
					<div class="loader-line"></div>
				</div>
				<div class="loader-line-wrap">
					<div class="loader-line"></div>
				</div>
			</div>
		</div>
	</center>
	   <div class="masthead">
			<nav>
			  <ul class="nav nav-pills nav-justified">
				<li class="active"><a href="#About" data-toggle="tab">About</a></li>
				<li><a href="#Play" data-toggle="tab">Play</a></li>
				<li><a href="#Guide" data-toggle="tab">Guide</a></li>
				<li><a href="#Social" data-toggle="tab">Social</a></li>
				<li><a href="#Account" data-toggle="tab"><?php echo $screen ?></a></li>
			  </ul>
			</nav>
		  </div>


    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
		<center>
			<h1>AIG Game</h1>
		</center>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
	  <div class="tab-content clearfix">
		<div class="tab-pane active" id="About">
		<?php if(isset($infoContent)){ ?>
			<div id="infoPanel" class="panel panel-info" style="<?php echo $info; ?>">
				<div class="panel-heading">Information <div class="pull-right"><button class="btn btn-default" style="margin-top: -5px;" type="button" onclick="closeInfo();">X</button></div></div>
				  <div class="panel-body">
					<?php echo $infoContent; ?>
				  </div>
			</div>
		<?php } ?>
			<div class="row">
				<ul class="nav nav-tabs">
				  <li class="active"><a data-toggle="tab" href="#home">About</a></li>
				  <li><a data-toggle="tab" href="#Research">Research</a></li>
				  <li><a data-toggle="tab" href="#Implementation">Implementation</a></li>
				  <li><a data-toggle="tab" href="#Code">Code</a></li>
				</ul>

				<div class="tab-content">
				  <div id="home" class="tab-pane fade in active">
					<h3>About</h3>
					<p>Welcome to AIG Game, a game that can be deployed on a social network to help teach risk mitigation. </p>
				  </div>
				  <div id="Research" class="tab-pane fade">
					<h3>Research</h3>
					<p>Some content in menu 1.</p>
				  </div>
				  <div id="Implementation" class="tab-pane fade">
					<h3>Implementation</h3>
					<p>Some content in menu 2.</p>
				  </div>
				  <div id="Code" class="tab-pane fade">
					<h3>Code</h3>
					<p>Some content in menu 2.</p>
				  </div>
				</div>
		  </div>
		</div>
		<div class="tab-pane" id="Play">
			<img id="spriteSheet" style="display:none" src="assets/sprites/<?php echo $sprite; ?>">
			<?php echo $moreSprites; ?>
			<center>
				<button id="launchbtn" class="btn btn-success" onclick="startGame()">Launch Game</button>
				<div id="game">
					
				</div>
			</center>
			<div id="simulationModal" class="modal fade" role="dialog">
			  <div class="modal-dialog">

				<!-- Modal content-->
				<div class="modal-content" style="height:600px;width:600px;">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Scrying Orb Simulation</h4>
				  </div>
				  <div class="modal-body">
				  <h2>Current State:</h2>
					<div class="col-md-6">
						<h4 id="simEconomy"></h4>
						<h4 id="simLifespan"></h4>
						<h4 id="simEnvironment"></h4>
					</div>
					<div class="col-md-6">
						<h4 id="simSafest"></h4>
						<h4 id="simRiskiest"></h4>
					</div>
					<div class="col-md-12">
					<h2>Future Projections</h2>
					<canvas id="simulationChart" width="400" height="400"></canvas>
					</div>
				  </div>
				</div>

			  </div>
			</div>
		</div>
		<div class="tab-pane" id="Interests">
			
		</div>
		<div class="tab-pane" id="Social">
			<?php
			if($sess == true){
				$addPeople = "";
				$friends = "";
				$addPeople = "";
				$conn = connect();
				$socialArr = json_decode(json_decode($social, true),true);
				foreach($socialArr as $friend){
					$stmt = $conn->prepare("SELECT * FROM `AIG_Players` WHERE `Name` = :name AND `Activated` = 'Yes'");
					$stmt->bindParam(':name', $friend, PDO::PARAM_STR);
					$stmt->execute();
					$result = $stmt->fetchAll();
					$dude = $result[0];
					$dudeSprite = $dude["Sprite"];
					$dudeRisk = $dude["Risk"];
					$src = "assets/sprites/" . substr($dudeSprite,0,strpos($dudeSprite,"/")) . "/single" . substr($dudeSprite,strpos($dudeSprite,"/"));
					$friends .= "<h4 id='friend$friend'><img src='$src'/> &nbsp; $friend <button type='button' data-toggle='modal' data-target='#friendChart' class='btn btn-default' onclick=\"showRisk('$dudeRisk')\">Risk</button> &nbsp;
						<button type='button' class='btn btn-danger' onclick=\"removeFriend('$friend')\">X</button>
					</h4>";
				}
				if($friends == ""){
					$friends = "<h4>No Friends Yet</h4>";
				}
				$stmt = $conn->prepare("SELECT * FROM `AIG_Players` WHERE `Activated` = 'Yes' ORDER BY `Name` ASC, RAND() Limit 100");
				$stmt->execute();
				$result = $stmt->fetchAll();
				$break = 0;
				foreach($result as $person){
					$friendbool = false;
					foreach($socialArr as $friend){
						if($friend == $person["Name"]){
							$friendbool = true;
							break;
						}
					}
					if($person["Name"] == $screen){
						$friendbool = true;
					}
					if($friendbool == false){
						$break++;
						$dudeSprite = $person["Sprite"];
						$dudeName = $person["Name"];
						$dudeRisk = $person["Risk"];
						$src = "assets/sprites/" . substr($dudeSprite,0,strpos($dudeSprite,"/")) . "/single" . substr($dudeSprite,strpos($dudeSprite,"/"));
						$addPeople .= "<h4 id='searchShow$dudeName'><img id='search$dudeName' src='$src'/> &nbsp; $dudeName &nbsp; <button type='button' class='btn btn-success' onclick=\"addFriend('$dudeName|$dudeRisk')\">Add Friend</button></h4>";
					
					}
					if($break == 25){
						break;
					}
				}
				if($break == 0){
					$addPeople = "<h4>Check Back Later</h4>";
				}
			
			
			?>
			<div class="col-md-6" style="height: 500px; overflow-y: auto;">
				<center>
					<h2>Friends:</h2>
					<div id="friends">
					<?php echo $friends; ?>
					</div>
				</center>
			</div>
			<div class="col-md-6" style="height: 500px; overflow-y: auto;">
				<center>
					<h2>Add People:</h2>
					<?php echo $addPeople; ?>
				</center>
			</div>
			<div id="friendChart" class="modal fade" role="dialog">
			  <div class="modal-dialog">

				<!-- Modal content-->
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Risk Profile</h4>
				  </div>
				  <div class="modal-body">
					<canvas id="friendRiskChart" width="400" height="400"></canvas>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				  </div>
				</div>

			  </div>
			</div>
			<?php }else{ ?>
			<center><h2>Please Login To Use Social</h2></center>
			<?php } ?>
		</div>
	  <div class="tab-pane" id="Guide">
			
		</div>
		<div class="tab-pane" id="Account">
		  <center>
		    <?php 
				if($sess == true){
				$dirs = array_filter(glob('/home/mindsumo/AIG/assets/sprites/*'), 'is_dir');
				$tabs = "";
				$content = "";
				foreach($dirs as $dir){
					$dirt = substr($dir,34);
					$files = array_filter(glob("/home/mindsumo/AIG/assets/sprites/$dirt/single/*"), 'is_file');
					foreach($files as $file){
						$filet = substr($file, strlen("/home/mindsumo/AIG/assets/sprites/$dirt/single/"));
						$content .= "<button type='button' onclick=\"spritePick('$dirt/$filet|assets/sprites/$dirt/single/$filet')\" class='btn btn-default'><img src='assets/sprites/$dirt/single/$filet'></button>";
					}
				}
				$single = "assets/sprites/" . substr($sprite,0,strpos($sprite,"/")) . "/single" . substr($sprite,strpos($sprite,"/"));
			?>
			<h2>Logged in as <?php echo $screen ?></h2>
			<br>
			<button class="btn btn-default" type="button" data-toggle='modal' data-target='#profileRiskChart' onclick="riskProfile();">Risk Profile</button> &nbsp;
			<button class="btn btn-primary" type="button" onclick="saveChanges();">Save Changes</button> &nbsp;
			<button class="btn btn-danger" type="button" onclick="logOut();">Log Out</button> 
			<h3>Current Sprite:</h3>
			<img id="currentSprite" src="<?php echo $single ?>"/>
			<h5>Please Select a Sprite</h5>
			
			<input style="display:none" type="text" id="spriteName" name="spriteName" value="general/officeman1.png"/>
			<div class='col-md-12'>
				<?php
					echo $content;
				?>
			</div>
			<a href="#">Back To Top</a>
			<?php 
				}else{
			?>
			<div id="loadLogin" class="sk-cube-grid" style="display:none">
			  <div class="sk-cube sk-cube1"></div>
			  <div class="sk-cube sk-cube2"></div>
			  <div class="sk-cube sk-cube3"></div>
			  <div class="sk-cube sk-cube4"></div>
			  <div class="sk-cube sk-cube5"></div>
			  <div class="sk-cube sk-cube6"></div>
			  <div class="sk-cube sk-cube7"></div>
			  <div class="sk-cube sk-cube8"></div>
			  <div class="sk-cube sk-cube9"></div>
			</div>
			<form id="login" target="remember" action="content/blank.html" method="GET" style="max-width:500px" autocomplete="on">
				<h2>Please Login or Create an Account:</h2>
				<div id="infoLogin" class="panel panel-info" style="display:none">
				<div class="panel-heading">Login Information <div class="pull-right"><button class="btn btn-default" style="margin-top: -5px;" type="button" onclick="closeInfoLogin();">X</button></div></div>
				  <div id="infoLoginContent" class="panel-body">
					
				  </div>
			</div>
			  <div id="emailGroup" class="form-group">
				<label for="email">Email Address</label>
				<input type="email" class="form-control" id="email" name="email" placeholder="Email">
				<span id="helpPassword" class="help-block">Needs to be confirmed</span>
			  </div>
			  <div id="screenGroup" class="form-group">
				<label for="screenName">Screen Name</label>
				<input type="text" class="form-control" id="screenName" name="screenName" placeholder="Screen Name">
				<span id="helpPassword" class="help-block">Unique Name Identifier</span>
			  </div>
			  <div id="passwordGroup" class="form-group">
				<label for="password">Password</label>
				<input type="password" class="form-control" id="password" name="password" placeholder="Password">
				<span id="helpPassword" class="help-block">At least 6 characters long.</span>
			  </div>
			  <button id="loginButton" type="submit" class="btn btn-default">Submit</button>
			</form>
			<iframe id="remember" name="remember" class="hidden" src="content/blank.html" style="display:none"></iframe>
			<?php
				}
			?>
		  </center>
		</div>
	</div>
	   <div id="profileRiskChart" class="modal fade" role="dialog">
			  <div class="modal-dialog">

				<!-- Modal content-->
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Risk Profile</h4>
				  </div>
				  <div class="modal-body">
					<canvas id="riskChart" width="400" height="400"></canvas>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				  </div>
				</div>

			  </div>
			</div>
      <hr>

      <footer>
	  <div class="row">
		<div class="col-md-6"> 
			<a href="mailto:paul@miscthings.xyz">Contact Email at paul@miscthings.xyz</a>
		</div>
		<div class="col-md-6 text-right"> 
			<p>&copy; Project Miscellaneous Things XYZ</p>
		</div>
		</div>
      </footer>
    </div> <!-- /container -->
	</div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/assets/bootstrap/js/jquery-3.1.0.min.js"></script>
    <script>window.jQuery || document.write('<script src="assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/tether.min.js"></script>
	<script type="text/javascript" src="js/mdb.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.2/Chart.bundle.min.js"></script>
	<script type="text/javascript" src="js/phaser.min.js"></script>
	<script type="text/javascript" src="js/index.js"></script>
	<script type="text/javascript" src="js/game.js"></script>
	<script type="text/javascript">
		$(window).on("load", function() {
			$(".loader").fadeOut("slow");
			$("#stuff").show();
		});
	</script>
  </body>
</html>
